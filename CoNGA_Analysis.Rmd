---
title: "CoNGA Analysis"
author: "Nick Borcherding"
date: "11/10/2022"
output: html_document
---
```{r}
require(Seurat)
require(DropletUtils)
library(reticulate)
dat <- readRDS('./data/processedData/Fullintegrated_seuratObjects_TFH.rds')
dat <- SplitObject(dat, split.by = "orig.ident")
```

# Migrating Seurat data to CoNGA
```{r}
for (i in seq_along(dat)) {
    write10xCounts(x = dat[[i]]@assays$RNA@counts,
                   barcodes = stringr::str_split(colnames(dat[[i]]@assays$RNA@counts), "_", simplify = TRUE)[,2],
                   type = "HDF5",
                   path = paste0('./data/preCoNGA/gex/', names(dat)[i], ".h5"))
}
```

# Each contig file must undergo conversion for compatibility

Ended up writing and running the following bash script: 

```{r, eval = F}
for i in {11..118};
do
python /Users/Nick/conga/scripts/setup_10x_for_conga.py \
--filtered_contig_annotations_csvfile "/Users/Nick/Documents/GitHub/COVID_TCR/data/sequencingRuns/s""$i""/filtered_contig_annotations.csv" \
--output_clones_file "/Users/Nick/Documents/GitHub/COVID_TCR/data/preCoNGA/s""$i""_clones.tsv" \
--organism human \
--no_kpca
done
```

```{r}
new.contigs <- list.files("./data/preCoNGA/contigs")
new.contigs <- new.contigs[!grepl("barcode", new.contigs)]

samples <- stringr::str_split(new.contigs, "_", simplify = TRUE)[,1]
for(i in seq_along(new.contigs)) {
  tmp <- read.delim(paste0("./data/preCoNGA/contigs/", new.contigs[i]))
}
```

```{r, eval = FALSE}

python /Users/Nick/conga/scripts/merge_samples.py \
--samples COVID_samples2.txt \
--output_clones_file merged_COVID_clones.tsv \
--output_gex_data merged_COVID_gex.h5ad \
--organism human 
```

```{r, eval = FALSE}

python /Users/Nick/conga/scripts/run_conga.py \
--all \
--gex_data merged_COVID_gex.h5ad \
--gex_data_type h5ad \
--clones_file merged_COVID_clones.tsv \
--organism human \
--graph_vs_graph \
--outfile_prefix ./CoNGA.output \
--no_kpca
```


```{r}
d <- dist(tfh@reductions$pca@cell.embeddings)
# Run the MDS procedure, k determines the number of dimensions
mds <- cmdscale(d = d, k = 2)
# cmdscale returns the cell embeddings, we first label the columns to ensure downstream
# consistency
colnames(mds) <- paste0("MDS_", 1:2)

mds <- as.data.frame(mds)

ggplot(mds, aes(x=mds[,1], y = mds[,2])) + 
  geom_point(aes(color = tfh$seurat_clusters))
# We will now store this as a custom dimensional reduction called 'mds'
pbmc[["mds"]] <- CreateDimReducObject(embeddings = mds, key = "MDS_", assay = DefaultAssay(pbmc))

# We can now use this as you would any other dimensional reduction in all downstream functions
DimPlot(pbmc, reduction = "mds", pt.size = 0.5)

plot(mds[,1], mds[,2])
```

```{r}
ad <- anndata::read_h5ad("./data/preCoNGA/CoNGA.output_final.h5ad")

meta.data <- data.frame(ad$obs)
meta.data$CTaa <- paste0(meta.data$cdr3a, "_", meta.data$cdr3b)

meta.data <- unique(meta.data[,c("clusters_gex", "clusters_tcr", "CTaa")])

x <- unique(meta.data$CTaa[which(duplicated(meta.data$CTaa))])
output <- NULL
for(i in seq_along(x)) {
  meta.tmp <- meta.data[meta.data$CTaa == x[i],]
  clusters_gex <- (paste(str_sort(unique(meta.tmp$clusters_gex)), collapse = ";"))
  clusters_tcr <- (paste(str_sort(unique(meta.tmp$clusters_tcr)), collapse = ";"))
  out <- c(clusters_gex, clusters_tcr, x[i])
  output <- rbind(output,out)
}
output <- as.data.frame(output)
colnames(output) <- c("clusters_gex", "clusters_tcr", "CTaa")

meta.data <- meta.data[-c(which(meta.data$CTaa %in% x)),]
meta.data <- rbind(meta.data, output)
rownames(meta.data) <- meta.data$CTaa
meta.data <- meta.data[,c(1:2)]


conga <- readRDS("./data/processedData/conga_tfh_seuratObject.rds")

output <- rescaleByNeighbors(
                  list(conga[["TRA.KF"]]@cell.embeddings[,1:30], 
                      conga[["TRB.KF"]]@cell.embeddings[,1:30]),
                  k = 100)

conga[["KF.only"]] <- CreateDimReducObject(
                                embeddings = as.matrix(output),
                                stdev = rep(0, ncol(output)),
                                key = "correctedTrex",
                                jackstraw = NULL,
                                misc = list())
conga <- FindNeighbors(conga, 
                       reduction = "KF.only", 
                       graph.name = c("KF_nn", "KF_snn"))
conga <- FindClusters(conga, 
                      algorithm = 4, 
                      graph.name = "KF_snn", 
                      resolution = 0.3)

conga <- RunUMAP(conga, 
                 dims = 1:60,
                 reduction = "KF.only", 
                      graph.name = "KFumap")

conga<- AddMetaData(conga, meta.data)
conga$clusters_gex[grepl(";",conga$clusters_gex)] <- "Multi"

conga$clusters_tcr <- factor(conga$clusters_tcr, levels = 0:15)
conga$clusters_gex <- factor(conga$clusters_gex, levels = c(0:13, "Multi"))

epitope <- stringr::str_sort(na.omit(unique(conga$TCRA.epitope)), numeric = TRUE)
        
ep.colors <- rev(brewer.pal(5, "RdYlBu"))[c(1,3,5)]
names(ep.colors) <- epitope

conga$TCRA.epitope <- factor(conga$TCRA.epitope, levels = epitope)






tcrdist <- data.frame(ad$obsm$X_gex_2d, CTaa = paste0(ad$obs$cdr3a, "_", ad$obs$cdr3b))
meta <- conga[[]]
tcrdist <- merge(tcrdist, meta, by = "CTaa")



centers = tcrdist %>% 
          group_by(clusters_gex) %>% 
          summarize(across(c("X1", "X2"),mean)) %>%
          as.data.frame()

centers <-  centers[-15,]
        

gex.clusters <- ggplot(tcrdist, aes(x= X1, y = X2)) + 
                  geom_point(aes(color = clusters_gex)) +
                  geom_text(data = centers, mapping =  aes(x=centers[,2], y = centers[,3], label = clusters_gex), 
                              color = "black", size = 5) + 
                  scale_color_tableau("Tableau 20")  +
                  guides(color = "none") + 
                  xlab("gexUMAP_1") + 
                  ylab("gexUMAP_2") + 
                  theme_classic()

epitope <- ggplot(tcrdist, aes(x= X1, y = X2)) + 
  geom_point(color = "grey") + 
  geom_point(data = subset(tcrdist, !is.na(TCRA.epitope)), 
             mapping = aes(color = TCRA.epitope)) + 
  xlab("gexUMAP_1") + 
  ylab("gexUMAP_2") + 
  scale_color_manual(values = ep.colors) + 
  theme_classic()

Trex.cluster <- ggplot(tcrdist, aes(x= X1, y = X2)) + 
                    geom_point(aes(color = KF_snn_res.0.3)) + 
                    scale_color_tableau("Tableau 20") +
                    xlab("gexUMAP_1") + 
                    ylab("gexUMAP_2") + 
                    guides(color=guide_legend(ncol=2))   + 
                    labs(color = "Trex Cluster") + 
                    theme_classic()

conga.cluster <- ggplot(tcrdist, aes(x= X1, y = X2)) + 
  geom_point(aes(color = clusters_tcr)) + 
  scale_color_tableau("Tableau 20")  +
  guides(color=guide_legend(ncol=2)) + 
  labs(color = "CoNGA Cluster") + 
  xlab("gexUMAP_1") + 
  ylab("gexUMAP_2") + 
  theme_classic()

df1 <- data.frame(prop.table(table(tcrdist$KF_snn_res.0.3, tcrdist$TCRA.epitope, useNA = "ifany"), margin = 1))

trex.break <- ggplot(df1, aes(x= Var1, y = Freq)) + 
  geom_bar(stat = "identity", position = "fill", aes(fill = Var2)) + 
  scale_fill_manual(values = ep.colors, na.value = "grey") + 
  theme_classic() + 
  scale_x_discrete(limits = rev) + 
  ylab("Relative Proportion")  + 
  guides(fill = "none") +
  coord_flip() + 
  theme(axis.title.y = element_blank())

df2 <- data.frame(prop.table(table(tcrdist$clusters_tcr, tcrdist$TCRA.epitope, useNA = "ifany"), margin = 1))
conga.break <- ggplot(df2, aes(x= Var1, y = Freq)) + 
                geom_bar(stat = "identity", position = "fill", aes(fill = Var2)) + 
                scale_fill_manual(values = ep.colors, na.value = "grey") + 
                theme_classic() + 
                scale_x_discrete(limits = rev) + 
                labs(fill = "Spike Epitopes") + 
                ylab("Relative Proportion") + 
                guides(fill = "none") +
                coord_flip() + 
                theme(axis.title.y = element_blank())

gex.clusters + conga.cluster + conga.break + epitope +  Trex.cluster + trex.break +  plot_layout(ncol = 3)
ggsave("conga.attempt1.png", height = 8, width = 13)
```

