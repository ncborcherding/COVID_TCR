---
title: "CoNGA Analysis"
author: "Nick Borcherding"
date: "11/10/2022"
output: html_document
---
```{r}
require(Seurat)
require(DropletUtils)
library(reticulate)
dat <- readRDS('./data/processedData/Fullintegrated_seuratObjects_TFH.rds')
dat <- SplitObject(dat, split.by = "orig.ident")
```

# Migrating Seurat data to CoNGA
```{r}
for (i in seq_along(dat)) {
    write10xCounts(x = dat[[i]]@assays$RNA@counts,
                   barcodes = stringr::str_split(colnames(dat[[i]]@assays$RNA@counts), "_", simplify = TRUE)[,2],
                   type = "HDF5",
                   path = paste0('./data/preCoNGA/gex/', names(dat)[i], ".h5"))
}
```

# Each contig file must undergo conversion for compatibility

Ended up writing and running the following bash script: 

```{r, eval = F}
for i in {11..118};
do
python /Users/Nick/conga/scripts/setup_10x_for_conga.py \
--filtered_contig_annotations_csvfile "/Users/Nick/Documents/GitHub/COVID_TCR/data/sequencingRuns/s""$i""/filtered_contig_annotations.csv" \
--output_clones_file "/Users/Nick/Documents/GitHub/COVID_TCR/data/preCoNGA/s""$i""_clones.tsv" \
--organism human \
--no_kpca
done
```

```{r}
new.contigs <- list.files("./data/preCoNGA/contigs")
new.contigs <- new.contigs[!grepl("barcode", new.contigs)]

samples <- stringr::str_split(new.contigs, "_", simplify = TRUE)[,1]
for(i in seq_along(new.contigs)) {
  tmp <- read.delim(paste0("./data/preCoNGA/contigs/", new.contigs[i]))
}
```

```{r, eval = FALSE}

python /Users/Nick/conga/scripts/merge_samples.py \
--samples COVID_samples2.txt \
--output_clones_file merged_COVID_clones.tsv \
--output_gex_data merged_COVID_gex.h5ad \
--organism human 
```

```{r, eval = FALSE}

python /Users/Nick/conga/scripts/run_conga.py \
--gex_data merged_COVID_gex.h5ad \
--gex_data_type h5ad \
--clones_file merged_COVID_clones.tsv \
--organism human \
--graph_vs_graph \
--outfile_prefix ./CoNGA.output \
--no_kpca
```

