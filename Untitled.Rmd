---
title: "Untitled"
author: "Nicholas Borcherding"
date: '2023-01-13'
output: html_document
---

Trying to identify edit distances for candidate TCRs
```{r cars}
library(Seurat)
library(stringdist)
conga <- readRDS("./data/processedData/conga_tfh_seuratObject.rds")
conga <- annotateDB(conga, chains = "TRB", edit.distance = 0)
conga <- annotateDB(conga, chains = "TRA", edit.distance = 0)

meta <- conga[[]]
meta <- meta[!is.na(meta$confirmation.seq),]
meta <- meta[order(meta$confirmation.seq),]

confirm.TCRA.gene <- as.vector(meta$TRAV)
confirm.TCRB.gene <- as.vector(meta$TRBV)
confirm.TCRA <- stringr::str_split(meta$CTaa, "_", simplify = TRUE)[,1]
confirm.TCRB <- stringr::str_split(meta$CTaa, "_", simplify = TRUE)[,2]
edit.distance <- 2

TCRA <- stringr::str_split(conga[[]]$CTaa, "_", simplify = TRUE)[,1]
TCRB <- stringr::str_split(conga[[]]$CTaa, "_", simplify = TRUE)[,2]
    
additions.TCRA <- lapply(confirm.TCRA, function(x) {
      pos <- which(stringdist(x, TCRA, method = "lv") <= edit.distance & 
                     stringdist(x, TCRA, method = "lv") > 0)
      pos
})

additions.TCRB <- lapply(confirm.TCRB, function(x) {
      pos <- which(stringdist(x, TCRB, method = "lv") <= edit.distance & 
                     stringdist(x, TCRB, method = "lv") > 0)
      pos
    })

conga@meta.data$confirmation.neighbors.TCRA <- NA
conga@meta.data$confirmation.neighbors.TCRB <- NA

for(i in seq_along(additions.TCRA)) {
  idx.A <- as.vector(conga@meta.data$TRAV[additions.TCRA[[i]]])
  idx.A <- which(idx.A == confirm.TCRA.gene[i])
  
  conga@meta.data$confirmation.neighbors.TCRA[additions.TCRA[[i]][idx.A]] <- paste0("TCR.", i)
}

for(i in seq_along(additions.TCRB)) {
   idx.B <- as.vector(conga@meta.data$TRBV[additions.TCRB[[i]]])
  idx.B <- which(idx.B == confirm.TCRB.gene[i])
  conga@meta.data$confirmation.neighbors.TCRB[additions.TCRB[[i]][idx.B]] <- paste0("TCR.", i)
}

meta <- conga[[]]
conga@meta.data$TCR.both <- paste0(conga@meta.data$confirmation.neighbors.TCRA, conga@meta.data$confirmation.neighbors.TCRB)

df <- data.frame(conga@reductions$phateTrex@cell.embeddings,
                  conga[[]])
df$TCR.both[df$TCR.both == "NANA"] <- NA
df$TCR.both <- stringr::str_remove_all(df$TCR.both, "NA")
df$TCR.both[df$TCR.both == "TCR.1TCR.1"] <- "TCR.1"
df$TCR.both[df$TCR.both == "TCR.2TCR.2"] <- "TCR.2"

df.sub <- subset(df, !is.na(confirmation.seq))
df.sub2 <- subset(df, !is.na(TCR.both))
write.csv(df.sub2, "Trex_edit.distance2_matchedVgenes.csv")

ggplot() +
    geom_point(data =df, aes(x=phateTrex_1, y = phateTrex_2, size = n), 
               fill = "grey", shape =21, stroke = 0.1) + 
  geom_point(data =df.sub2, aes(x=phateTrex_1, y = phateTrex_2, size = n, fill = TCR.both), shape =21, stroke = 0.1) + 
    geom_point(data = df.sub, aes(x=phateTrex_1, y = phateTrex_2, fill = confirmation.seq), 
               size = 4, shape =21, stroke = 0.2) + 
    scale_fill_manual(values = brewer.pal(5, "RdYlBu")) +
    theme_void()
ggsave("added_edit.distance.png", height = 4, width = 5)
```

# Figure 4
```{r}
conga$TCRA.COVID <- "No"
conga$TCRA.COVID[grepl("SARS-CoV-2", conga$TRA_Epitope.species)] <- "Yes"
conga$TCRA.COVID[!is.na(conga$TCRA.epitope)] <- "Yes"
TCRA.ref <- data.frame("CTaa" = conga$CTaa, "COVID" = conga$TCRA.COVID)
TCRA.ref <- subset(TCRA.ref, COVID == "Yes")

conga$TCRB.COVID <- "No"
conga$TCRB.COVID[grepl("SARS-CoV-2", conga$TRB_Epitope.species)] <- "Yes"
conga$TCRB.COVID[!is.na(conga$TCRB.epitope)] <- "Yes"
TCRB.ref <- data.frame("CTaa" = conga$CTaa, "COVID" = conga$TCRB.COVID)
TCRB.ref <- subset(TCRB.ref, COVID == "Yes")

SeuratObj <- readRDS("./data/processedData/Fullintegrated_seuratObjects_TFH_TFHonly.rds")

updated.shared.clones <- sort(unique(c(TCRB.ref$CTaa, TCRA.ref$CTaa)))
dir.create("./output/Figure4")
```

Figure 4A

```{r}
subset.obj <- subset(SeuratObj, CTaa %in% updated.shared.clones)
subset.obj$timeline <- "Late"
subset.obj$timeline[subset.obj$timepoint %in% c("d28", "d60")] <- "Early"

Idents(subset.obj) <- "timeline"
EvL.markers <- FindMarkers(subset.obj, 
                           ident.1 = "Early",
                           test.use = "MAST", 
                           latent.vars = "donor", 
                           logfc.threshold = 0,
                           min.pct = 0,
                           pseudocount.use = 0.1)

write.csv(EvL.markers, "./output/Tfh.DEG.EarlyvsLate.csv")
EvL.markers <- EvL.markers %>%
                mutate(Percent.Delta = pct.1 - pct.2)
EvL.markers$genes <- rownames(EvL.markers)
rb.palette <- colorRampPalette(brewer.pal(11, "RdYlBu"))(11)

top10 <- EvL.markers %>% 
  subset(p_val < 0.05) %>%
  slice_max(order_by = avg_log2FC, n = 10)

bottom10 <- EvL.markers %>% 
  subset(p_val < 0.05) %>%
  slice_min(order_by = avg_log2FC, n = 10)

EvL.plot <- ggplot(EvL.markers, aes(x = avg_log2FC, y = -log10(p_val))) + 
  geom_point(aes(size = Percent.Delta), color = "grey") + 
  geom_point(data=subset(EvL.markers, genes %in% top10$genes),
             aes(size = Percent.Delta), color = rb.palette[1]) + 
  geom_point(data=subset(EvL.markers, genes %in% bottom10$genes),
             aes(size = Percent.Delta), color = rb.palette[11]) + 
  geom_text_repel(data=subset(EvL.markers, genes %in% c(top10$genes,bottom10$genes)), aes(label = genes), max.overlaps = 20) + 
  theme_classic() + 
  scale_size(range = c(0.1,3)) + 
  geom_hline(yintercept = 1.3) + 
  geom_vline(xintercept = 0)



Idents(subset.obj) <- "timepoint"
FvL.markers <- FindMarkers(subset.obj, 
                           ident.1 = "d28",
                           ident.2 = "d201",
                           test.use = "MAST", 
                           latent.vars = "donor", 
                           logfc.threshold = 0,
                           min.pct = 0,
                           pseudocount.use = 0.1)

write.csv(FvL.markers, "./output/Tfh.DEG.d28vsd201.csv")

FvL.markers <- FvL.markers %>%
                mutate(Percent.Delta = pct.1 - pct.2)
FvL.markers$genes <- rownames(FvL.markers)

top10 <- FvL.markers %>% 
  subset(p_val < 0.05) %>%
  slice_max(order_by = avg_log2FC, n = 10)

bottom10 <- FvL.markers %>% 
  subset(p_val < 0.05) %>%
  slice_min(order_by = avg_log2FC, n = 10)

FvL.plot <- ggplot(FvL.markers, aes(x = avg_log2FC, y = -log10(p_val))) + 
  geom_point(aes(size = Percent.Delta), color = "grey") + 
  geom_point(data=subset(FvL.markers, genes %in% top10$genes),
             aes(size = Percent.Delta), color = rb.palette[1]) + 
  geom_point(data=subset(FvL.markers, genes %in% bottom10$genes),
             aes(size = Percent.Delta), color = rb.palette[11]) + 
  geom_text_repel(data=subset(FvL.markers, genes %in% c(top10$genes,bottom10$genes)), aes(label = genes), max.overlaps = 20) + 
  theme_classic() + 
  scale_size(range = c(0.1,3)) + 
  geom_hline(yintercept = 1.3) + 
  geom_vline(xintercept = 0)

EvL.plot + FvL.plot
ggsave("./output/Figure4/Figure4A.png", height = 4.5, width = 10, dpi = 600)

```

```{r}
meta <- subset.obj[[]]

ES2 <- ES[rownames(ES) %in% rownames(meta),]
colnames(ES2) <- stringr::str_remove_all(colnames(ES2), "_UCell")
variances <- apply(ES2, 2, var)
#ES2 <- ES2[,-which(variances == 0)]

pathways <- colnames(ES2)

ES2 <- merge(ES2, meta, by = 0)

sig.results <- getSignificance(ES2, 
                               group = "timepoint", 
                               gene.sets = pathways, 
                               fit = "KW")
rownames(sig.results) <- stringr::str_remove_all(rownames(sig.results), "_UCell")

sig.results2 <- getSignificance(ES2, 
                               group = "timepoint", 
                               gene.sets = pathways, 
                               fit = "ANOVA")
rownames(sig.results2) <- stringr::str_remove_all(rownames(sig.results2), "_UCell")

KW.sig.pathways <- sig.results %>%
                        filter(p.value < 0.05) %>%
                        slice_max(order_by = Chi.square, n = 200) %>%
                        rownames() 

ANOVA.sig.pathways <- sig.results2 %>%
                        filter(p.value < 0.05) %>%
                        slice_max(order_by = f.value, n = 200) %>%
                        rownames()

pathways.intersect <- intersect(KW.sig.pathways, ANOVA.sig.pathways)
old.pathways <- read.csv("./output/int.pathways.csv")

pathways.intersect <- pathways.intersect[!grepl("REACTOME", pathways.intersect) ]
pathways.intersect <- pathways.intersect[-c(8,10,11,15,16)]
write(pathways.intersect, "output/Agspecific.intersected.pathways.txt")

summary <- ES2 %>%
  group_by(timepoint) %>%
  summarise(across(pathways.intersect, median))

normalize <- function(x) {
      (x- min(x)) /(max(x)-min(x))
}

for(i in 2:49) {
  summary[,i] <- normalize(summary[,i])
}
summary <- as.data.frame(summary)

rownames(summary) <- summary$timepoint



pdf("./output/Figure4/Figure4b.pdf", height = 8, width = 10)
pheatmap::pheatmap(t(summary[,2:49]))
dev.off()
```

Figure 4C 
```{r}
dir.create("./output/Figure4")
conga$TCRA.COVID <- "No"
conga$TCRA.COVID[grepl("SARS-CoV-2", conga$TRA_Epitope.species)] <- "Yes"
conga$TCRA.COVID[!is.na(conga$TCRA.epitope)] <- "Yes"
TCRA.ref <- data.frame("CTaa" = conga$CTaa, "COVID" = conga$TCRA.COVID)
TCRA.ref <- subset(TCRA.ref, COVID == "Yes")

conga$TCRB.COVID <- "No"
conga$TCRB.COVID[grepl("SARS-CoV-2", conga$TRB_Epitope.species)] <- "Yes"
conga$TCRB.COVID[!is.na(conga$TCRB.epitope)] <- "Yes"
TCRB.ref <- data.frame("CTaa" = conga$CTaa, "COVID" = conga$TCRB.COVID)
TCRB.ref <- subset(TCRB.ref, COVID == "Yes")

SeuratObj <- readRDS("./data/processedData/Fullintegrated_seuratObjects_TFH_TFHonly.rds")

updated.shared.clones <- sort(unique(c(TCRB.ref$CTaa, TCRA.ref$CTaa)))
clone.palette <- colorRampPalette(brewer.pal(11, "RdYlBu"))(249)
names(clone.palette) <- updated.shared.clones

return.cc <- compareClonotypes(SeuratObj, 
                  clonotypes = updated.shared.clones, 
                  split.by = "timepoint",
                  cloneCall="aa", 
                  graph = "alluvial",
                  exportTable = TRUE)
uni.clones <- unique(return.cc$Clonotypes[return.cc$Sample == "d28"])
"%!in%" <- Negate("%in%")
all.times <- c("d28", "d60", "d110", "d201")
output <- NULL
for(i in seq_along(uni.clones)) {
  x <- return.cc[return.cc$Clonotypes == uni.clones[i],]
  placement <- names(which(table(x$Sample) == 1))
  new.times <- all.times[all.times %!in% placement]
  rep.value <- length(new.times)
  y <- data.frame(Clonotypes = rep(uni.clones[i], rep.value), Proportion = rep(0, rep.value), Sample = new.times)
  output <- rbind(output, y)
  
}
  return.cc <- rbind(return.cc, output)
  return.cc$Sample <- factor(return.cc$Sample, levels = c("d28", "d60", "d110", "d201"))
  ggplot(return.cc, aes(x = Sample, 
                        fill = Clonotypes, 
                        group = Clonotypes,
                    stratum = Clonotypes, 
                    alluvium = Clonotypes, 
                    y = Proportion, label = Clonotypes)) +
                theme_classic() +
                theme(axis.title.x = element_blank()) + 
                geom_stratum() +
                geom_flow(stat = "alluvium") + 
                guides(fill = "none")  + 
                scale_fill_manual(values = clone.palette)
  ggsave("./output/Figure4/Figure4C.pdf", height = 4, width = 6)
```

